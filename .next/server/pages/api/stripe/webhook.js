"use strict";(()=>{var e={};e.id=815,e.ids=[815],e.modules={4217:e=>{e.exports=require("micro")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6090:e=>{e.exports=import("stripe")},4520:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.r(t),a.d(t,{config:()=>u,default:()=>c,routeModule:()=>l});var i=a(1802),s=a(7153),o=a(6249),d=a(321),n=e([d]);d=(n.then?(await n)():n)[0];let c=(0,o.l)(d,"default"),u=(0,o.l)(d,"config"),l=new i.PagesAPIRouteModule({definition:{kind:s.x.PAGES_API,page:"/api/stripe/webhook",pathname:"/api/stripe/webhook",bundlePath:"",filename:""},userland:d});r()}catch(e){r(e)}})},1716:(e,t,a)=>{a.d(t,{Z:()=>o});let r=require("@prisma/client"),i=global,s=i.prisma||new r.PrismaClient,o=s},6111:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.d(t,{Z:()=>d});var i=a(6090),s=e([i]);i=(s.then?(await s)():s)[0];let o=new i.default(process.env.STRIPE_SECRET_KEY),d=o;r()}catch(e){r(e)}})},321:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.r(t),a.d(t,{config:()=>n,default:()=>handler});var i=a(4217),s=a(6111),o=a(1716),d=e([s]);s=(d.then?(await d)():d)[0];let n={api:{bodyParser:!1}};async function handler(e,t){let a;let r=e.headers["stripe-signature"],d=await (0,i.buffer)(e);try{a=s.Z.webhooks.constructEvent(d,r,process.env.STRIPE_WEBHOOK_SECRET)}catch(e){return console.error("Webhook signature verification failed.",e.message),t.status(400).send(`Webhook Error: ${e.message}`)}if("checkout.session.completed"===a.type){let e=a.data.object,t=e.metadata?.userId,r=await o.Z.order.findFirst({where:{userId:t,status:"PENDING"},orderBy:{createdAt:"desc"}});r&&await o.Z.order.update({where:{id:r.id},data:{status:"PAID",verified:!0}})}t.json({received:!0})}r()}catch(e){r(e)}})}};var t=require("../../../webpack-api-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),a=t.X(0,[222],()=>__webpack_exec__(4520));module.exports=a})();